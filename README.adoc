= Deploying VSCode on Amazon EKS

image:images/main-dashboard.png[]

== About
This repository is a walkthrough of deploying the link:https://coder.com[Coder.com] official link:https://hub.docker.com/r/codercom/code-server[code-server Docker image of VSCode] in a repeatable tutorial/workshop format.  After working through this lab you will have a web-accessable deployment of VSCode running on Amazon EKS Kubernetes, backed by persistent EBS volumes.  Now you can code anywhere using your preferred IDE!

== Contents
* link:https://github.com/bbertka/code-server-eks#part-1---preparing-for-installation[Install Readiness]
* link:https://github.com/bbertka/code-server-eks#part-2---deploy-an-amazon-eks-cluster[Deploy EKS Cluster]
* link:https://github.com/bbertka/code-server-eks#part-3---setup-cluster-ingress[Setup ALB Ingress for your Cluster]
* link:https://github.com/bbertka/code-server-eks#part-4---deploy-code-server[Deploy code-server]]

== Assumptions
* You already have an AWS account

[#preparing-for-installation]
= Part 1 - Preparing for Installation

== Setup AWS CLI
. Download and Install AWS CLI v2. 
+
----
$ curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
----
. Check for successful installation
+
----
$ aws --version
aws-cli/2.0.38 Python/3.7.4 Darwin/17.7.0 exe/x86_64
----

. Configure your AWS credentials for your preferred region
+
----
$ aws configure
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
Default region name [None]: us-east-2
Default output format [None]: json
----

== Setup Amazon EKS CLI - eksctl
. If using a Mac, we are assuming you have homebrew installed, otherwise please install it now
+
----
$ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
----
. Next, install the Weavworks tap
+
----
$ brew tap weaveworks/tap
----

. Finally, install eksctl
+
----
$ brew install weaveworks/tap/eksctl
---- 

. Check for successful installation
+
----
$ eksctl version
0.25.0
----

== Setup kubectl
. Download and Install kubectl
+
----
$ curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl"
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
----
. Check for successful installation
+
----
$ kubectl version --client
    Client Version: version.Info { 
    Major:"1",
    Minor:"18",
    GitVersion:"v1.18.4",
    GitCommit:"c96aede7b5205121079932896c4ad89bb93260af",
    GitTreeState:"clean",
    BuildDate:"2020-06-17T11:41:22Z",
    GoVersion:"go1.13.9",
    Compiler:"gc", 
    Platform:"darwin/amd64"
    }
----

[#deploy-an-amazon-eks-cluster]
= Part 2 - Deploy an Amazon EKS Cluster
In order to deploy the Docker image for code-server, we need an EKS cluster to work with.  There are two options for us for backing an EKS cluster, Fargate, or your own managed VPC nodes.  Since VSCode needs some persistence in order to make this usuable for you in a production-like setting, we are opting for managed nodes deployment to make it easier to deploy with persistent vilume claims via EBS.

. Download or copy your AWS public SSH key to your current directory and make sure the permissions are set securely.
+
----
$ cp ~/eks.pub . && chmod 600 eks.pub
----

. Create an EKS cluster in your region, with a node size of your choice and using your key, for example: 
+
----
$ eksctl create cluster \
 --name code-server \
 --version 1.17 \
 --region us-east-2 \
 --nodegroup-name linux-nodes \
 --node-type t3.micro \
 --nodes 3 \
 --nodes-min 1 \
 --nodes-max 3 \
 --ssh-access \
 --ssh-public-key eks.pub \
 --managed
----

. After 10-15 minutes, test that Kubectl has been configured correctly
+
----
$ kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.100.0.1   <none>        443/TCP   56m
----


[#setup-cluster-ingress]
= Part 3 - Setup Cluster Ingress
To have access to our IDE via the browser, we need to load balancce to the running container within Kubernetes. To do this we create an Application Load Balancer.  Fortunetly, AWS provides an ALB controller to make this easy for us which integrates nicely with EKS.

. Create an IAM OIDC provider and associate it with your cluster
+
----
$ eksctl utils associate-iam-oidc-provider \
    --region us-east-2 \
    --cluster code-server \
    --approve
----

. Download an IAM policy for the ALB Ingress Controller pod that allows it to make calls to AWS APIs on your behalf
+
----
curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.8/docs/examples/iam-policy.json
----

. Create an IAM policy called ALBIngressControllerIAMPolicy using the policy downloaded in the previous step.  Take note of the ARN policy string that was created for a following step.
+
----
$ aws iam create-policy \
    --policy-name ALBIngressControllerIAMPolicy \
    --policy-document file://iam-policy.json
----

. Create a Kubernetes service account named alb-ingress-controller in the kube-system namespace, a cluster role, and a cluster role binding for the ALB Ingress Controller to use with the following command
+
----
kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.8/docs/examples/rbac-role.yaml
----

. Create an IAM role for the ALB Ingress Controller and attach the role to the service account created in the previous step. The command that follows only works for clusters that were created with eksctl.  Note use your ARN from the previous step.
+
----
eksctl create iamserviceaccount \
    --region us-east-2 \
    --name alb-ingress-controller \
    --namespace kube-system \
    --cluster code-server \
    --attach-policy-arn arn:aws:iam::111122223333:policy/ALBIngressControllerIAMPolicy \
    --override-existing-serviceaccounts \
    --approve
----

. Deploy your ALB Controller, note that initially it will error until the subsequent steps
+
----
$ kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.8/docs/examples/alb-ingress-controller.yaml
----

. Edit the ALB Deployment with your cluster name, your EKS VPC, and region
+
----
kubectl edit deployment.apps/alb-ingress-controller -n kube-system

...
    spec:
      containers:
      - args:
        - --ingress-class=alb
        - --cluster-name=code-server
        - --aws-vpc-id=vpc-03468a8157edca5bd
        - --aws-region=us-east-2
----

. Confirm that the ALB Ingress Controller is running with the following command.
+
----
$ kubectl get pods -n kube-system
NAME                                      READY   STATUS    RESTARTS   AGE
alb-ingress-controller-646d767ccf-4h624   1/1     Running   0          12s
----


[#deploy-code-server]
= Part 3 - Deploy Code Server
